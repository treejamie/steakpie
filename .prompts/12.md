

# Summary
In this work we're going to tackle an issue that appeared when testing in a live environment. The logs for this are in Annex A at the end of this prompt.  I've also included an Annex B which is a full example of the happy path payload we're looking for

The issue is multiple unique webhook ids are being send when one image is updated on the server. This is causing steakpie to fire multiple times, which is not ideal.

We need to more clearly define how we de-duplicate and ensure idemopotancy as using only X-github-delivery-id header isn't sufficient.

In order to do this work we're going to have to change the structure of the sqlite table and inspect json payloads to use three atttributes from inside the JSON data:

1. registry_package.package_version.container_metadata.tag - referred to as "tag" - string
2. registry_package.package_version.id - referred to as "version_id" - big integer
3. registry_package.package_version.version - referred to as "sha" - long sha256 string.

In theory it's quite simple, we're just looking for the container_metadata.tag of "latest" but we still need to check other things.


# Details

## sqlite database

Ensure the database has columns for "tag", "version_id" and "sha" in the events table. Also rename the "id" column to "delivery_id".  These types of changes have a habit of breaking code, so before going any further, check all tests pass.



## idempotancy approach.


We're looking for 

1. Check registry_package.package_version.container_metadata.tag, if the value isn't "latest", we're not interested in this, so log a clear message to that effect and move on. No saving into the database.

2. If the value is latest, then check the database for rows with matching delivery_id, tag, version_id and sha. If there is a match, we go no further and log a meaningful message and we're done.

3. At this point we will have a unique delivery_id, version_id, sha and the tag will be "latest" so we're good to proceed. So we insert the values into the database and immediately COMMIT the values. It appears you're not currently doing that and it could lead to race conditions. 

4. So now we have an idempotant payload, we have inserted and commited the details into the database and we are clear to go.



## Annex A - logs that lead me to see the idempotancy issue.

```logs
2026/02/07 16:20:40 ✓ Found 1 command(s) for package jamiec_ts
2026/02/07 16:20:40 start webhook for jamiec_ts received with id: f168a0a0-0440-11f1-9b3f-a185afe7eea8
2026/02/07 16:20:40 running command 1 of 1: docker compose pull - doppler run -- docker compose up -d
2026/02/07 16:20:41 output: no configuration file provided: not found
2026/02/07 16:20:41 command 1 of 1 failed: exit status 1
2026/02/07 16:20:41 end webhook for jamiec_ts with id: f168a0a0-0440-11f1-9b3f-a185afe7eea8
2026/02/07 16:20:41 Received POST request from [::1]:50224
2026/02/07 16:20:41 event is new, proceed to dispatch
2026/02/07 16:20:41 ✓ Successfully processed published event for package jamiec_ts (version sha256:3ab167c9d19c55d820a390846db7c730cc858cb95ffe6d2f610050c04aad8787)
2026/02/07 16:20:41 ✓ Found 1 command(s) for package jamiec_ts
2026/02/07 16:20:41 start webhook for jamiec_ts received with id: f1a53470-0440-11f1-87e2-7761621fcece
2026/02/07 16:20:41 running command 1 of 1: docker compose pull - doppler run -- docker compose up -d
2026/02/07 16:20:41 output: no configuration file provided: not found
2026/02/07 16:20:41 command 1 of 1 failed: exit status 1
2026/02/07 16:20:41 end webhook for jamiec_ts with id: f1a53470-0440-11f1-87e2-7761621fcece
2026/02/07 16:20:41 Received POST request from [::1]:50224
2026/02/07 16:20:41 event is new, proceed to dispatch
2026/02/07 16:20:41 ✓ Successfully processed published event for package jamiec_ts (version sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab)
2026/02/07 16:20:41 ✓ Found 1 command(s) for package jamiec_ts
2026/02/07 16:20:41 start webhook for jamiec_ts received with id: f1e8cd20-0440-11f1-8e82-27c317883355
2026/02/07 16:20:41 running command 1 of 1: docker compose pull - doppler run -- docker compose up -d
2026/02/07 16:20:41 output: no configuration file provided: not found
2026/02/07 16:20:41 command 1 of 1 failed: exit status 1
2026/02/07 16:20:41 end webhook for jamiec_ts with id: f1e8cd20-0440-11f1-8e82-27c317883355
2026/02/07 16:20:42 Received POST request from [::1]:50224
2026/02/07 16:20:42 event is new, proceed to dispatch
2026/02/07 16:20:42 ✓ Successfully processed published event for package jamiec_ts (version sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab)
2026/02/07 16:20:42 ✓ Found 1 command(s) for package jamiec_ts
2026/02/07 16:20:42 start webhook for jamiec_ts received with id: f27359e0-0440-11f1-99be-4d02550d037a
2026/02/07 16:20:42 running command 1 of 1: docker compose pull - doppler run -- docker compose up -d
2026/02/07 16:20:42 output: no configuration file provided: not found
2026/02/07 16:20:42 command 1 of 1 failed: exit status 1
2026/02/07 16:20:42 end webhook for jamiec_ts with id: f27359e0-0440-11f1-99be-4d02550d037a
2026/02/07 16:20:43 Received POST request from [::1]:50224
2026/02/07 16:20:43 event is new, proceed to dispatch
2026/02/07 16:20:43 ✓ Successfully processed published event for package jamiec_ts (version sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab)
2026/02/07 16:20:43 ✓ Found 1 command(s) for package jamiec_ts
2026/02/07 16:20:43 start webhook for jamiec_ts received with id: f2dc06c0-0440-11f1-92e1-2b19086f97a8
2026/02/07 16:20:43 running command 1 of 1: docker compose pull - doppler run -- docker compose up -d
2026/02/07 16:20:43 output: no configuration file provided: not found
2026/02/07 16:20:43 command 1 of 1 failed: exit status 1
2026/02/07 16:20:43 end webhook for jamiec_ts with id: f2dc06c0-0440-11f1-92e1-2b19086f97a8
```


## Annex B - Full Example payload 

This is an example of a payload with the correct 'latest' tag.


```json
{
  "action": "published",
  "registry_package": {
    "id": 10452243,
    "name": "jamiec_ts",
    "namespace": "treejamie",
    "description": "",
    "ecosystem": "CONTAINER",
    "package_type": "CONTAINER",
    "html_url": "https://github.com/treejamie/packages/10452243",
    "created_at": "2026-02-06T08:58:40Z",
    "updated_at": "2026-02-07T16:20:40Z",
    "owner": {
      "login": "treejamie",
      "id": 1866,
      "node_id": "MDQ6VXNlcjE4NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1866?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/treejamie",
      "html_url": "https://github.com/treejamie",
      "followers_url": "https://api.github.com/users/treejamie/followers",
      "following_url": "https://api.github.com/users/treejamie/following{/other_user}",
      "gists_url": "https://api.github.com/users/treejamie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/treejamie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/treejamie/subscriptions",
      "organizations_url": "https://api.github.com/users/treejamie/orgs",
      "repos_url": "https://api.github.com/users/treejamie/repos",
      "events_url": "https://api.github.com/users/treejamie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/treejamie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "package_version": {
      "id": 675688875,
      "version": "sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab",
      "name": "sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab",
      "description": "",
      "summary": "",
      "body": {
        "repository": {
          "repository": {
            "id": 1151246365,
            "name": "jamiec_ts",
            "owner_id": 1866,
            "parent_id": null,
            "sandbox": null,
            "updated_at": "2026-02-07T15:52:30.000Z",
            "created_at": "2026-02-06T08:22:38.000Z",
            "public": true,
            "description": "A typescript rewrite of the elixir version",
            "homepage": null,
            "source_id": 1029516735,
            "public_push": null,
            "disk_usage": 36,
            "locked": false,
            "pushed_at": "2026-02-07T15:52:27.000Z",
            "watcher_count": 0,
            "public_fork_count": 0,
            "primary_language_name_id": 287,
            "has_issues": true,
            "has_wiki": true,
            "has_downloads": true,
            "organization_id": null,
            "disabled_at": null,
            "disabled_by": null,
            "disabling_reason": null,
            "health_status": null,
            "pushed_at_usec": 576988,
            "active": true,
            "reflog_sync_enabled": false,
            "made_public_at": "2026-02-06T08:22:38.000Z",
            "user_hidden": 0,
            "maintained": true,
            "template": false,
            "owner_login": "treejamie",
            "world_writable_wiki": false,
            "refset_updated_at": "2026-02-07T15:52:27.000Z",
            "disabling_detail": null,
            "archived_at": null,
            "deleted_at": null,
            "raw_data": {
              "data": {
                "created_by_user_id": 1866,
                "primary_language_name": "TypeScript",
                "completed_onboarding_tasks": [

                ]
              }
            }
          }
        },
        "info": {
          "path": "README.md",
          "name": "README.md",
          "mode": 33188,
          "type": "blob",
          "oid": "bb8506331b67d7b2b0355c4a7939d3d1c3ffcd20",
          "size": 224,
          "collection": true
        },
        "attributes": {

        },
        "_formatted": true
      },
      "manifest": "",
      "html_url": "https://github.com/users/treejamie/packages/container/jamiec_ts/675688875",
      "target_commitish": "main",
      "target_oid": "a9119552e8f90bb950ac5c786bd517d49c1a1eda",
      "created_at": "0001-01-01T00:00:00Z",
      "updated_at": "0001-01-01T00:00:00Z",
      "metadata": [

      ],
      "container_metadata": {
        "tag": {
          "name": "latest",
          "digest": "sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab"
        },
        "labels": {
          "description": "",
          "source": "",
          "revision": "",
          "image_url": "",
          "licenses": "",
          "all_labels": {
            "github.internal.platforms": "[{\"digest\":\"sha256:12077d6a2bfbc91fc7246e994d550a9f0c6a72e21db29805667b7e1822e89684\",\"architecture\":\"arm64\",\"os\":\"linux\"},{\"digest\":\"sha256:3ab167c9d19c55d820a390846db7c730cc858cb95ffe6d2f610050c04aad8787\",\"architecture\":\"unknown\",\"os\":\"unknown\"}]"
          }
        },
        "manifest": {
          "digest": "sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab",
          "media_type": "application/vnd.oci.image.index.v1+json",
          "uri": "repositories/treejamie/jamiec_ts/manifests/sha256:b97c4e077049470ac32d6b8c418eb536fb9856011ac1d6928b80f74926383aab",
          "size": 856,
          "config": {
            "digest": "",
            "media_type": "",
            "size": 0
          },
          "layers": [

          ]
        }
      },
      "package_files": [

      ],
      "installation_command": "docker pull ghcr.io/treejamie/jamiec_ts:latest",
      "package_url": "ghcr.io/treejamie/jamiec_ts:latest"
    },
    "registry": {
      "about_url": "https://docs.github.com/packages/learn-github-packages/introduction-to-github-packages",
      "name": "GitHub CONTAINER registry",
      "type": "CONTAINER",
      "url": "https://CONTAINER.pkg.github.com/treejamie",
      "vendor": "GitHub Inc"
    }
  },
  "repository": {
    "id": 1151246365,
    "node_id": "R_kgDORJ6gHQ",
    "name": "jamiec_ts",
    "full_name": "treejamie/jamiec_ts",
    "private": false,
    "owner": {
      "login": "treejamie",
      "id": 1866,
      "node_id": "MDQ6VXNlcjE4NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1866?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/treejamie",
      "html_url": "https://github.com/treejamie",
      "followers_url": "https://api.github.com/users/treejamie/followers",
      "following_url": "https://api.github.com/users/treejamie/following{/other_user}",
      "gists_url": "https://api.github.com/users/treejamie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/treejamie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/treejamie/subscriptions",
      "organizations_url": "https://api.github.com/users/treejamie/orgs",
      "repos_url": "https://api.github.com/users/treejamie/repos",
      "events_url": "https://api.github.com/users/treejamie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/treejamie/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "html_url": "https://github.com/treejamie/jamiec_ts",
    "description": "A typescript rewrite of the elixir version",
    "fork": false,
    "url": "https://api.github.com/repos/treejamie/jamiec_ts",
    "forks_url": "https://api.github.com/repos/treejamie/jamiec_ts/forks",
    "keys_url": "https://api.github.com/repos/treejamie/jamiec_ts/keys{/key_id}",
    "collaborators_url": "https://api.github.com/repos/treejamie/jamiec_ts/collaborators{/collaborator}",
    "teams_url": "https://api.github.com/repos/treejamie/jamiec_ts/teams",
    "hooks_url": "https://api.github.com/repos/treejamie/jamiec_ts/hooks",
    "issue_events_url": "https://api.github.com/repos/treejamie/jamiec_ts/issues/events{/number}",
    "events_url": "https://api.github.com/repos/treejamie/jamiec_ts/events",
    "assignees_url": "https://api.github.com/repos/treejamie/jamiec_ts/assignees{/user}",
    "branches_url": "https://api.github.com/repos/treejamie/jamiec_ts/branches{/branch}",
    "tags_url": "https://api.github.com/repos/treejamie/jamiec_ts/tags",
    "blobs_url": "https://api.github.com/repos/treejamie/jamiec_ts/git/blobs{/sha}",
    "git_tags_url": "https://api.github.com/repos/treejamie/jamiec_ts/git/tags{/sha}",
    "git_refs_url": "https://api.github.com/repos/treejamie/jamiec_ts/git/refs{/sha}",
    "trees_url": "https://api.github.com/repos/treejamie/jamiec_ts/git/trees{/sha}",
    "statuses_url": "https://api.github.com/repos/treejamie/jamiec_ts/statuses/{sha}",
    "languages_url": "https://api.github.com/repos/treejamie/jamiec_ts/languages",
    "stargazers_url": "https://api.github.com/repos/treejamie/jamiec_ts/stargazers",
    "contributors_url": "https://api.github.com/repos/treejamie/jamiec_ts/contributors",
    "subscribers_url": "https://api.github.com/repos/treejamie/jamiec_ts/subscribers",
    "subscription_url": "https://api.github.com/repos/treejamie/jamiec_ts/subscription",
    "commits_url": "https://api.github.com/repos/treejamie/jamiec_ts/commits{/sha}",
    "git_commits_url": "https://api.github.com/repos/treejamie/jamiec_ts/git/commits{/sha}",
    "comments_url": "https://api.github.com/repos/treejamie/jamiec_ts/comments{/number}",
    "issue_comment_url": "https://api.github.com/repos/treejamie/jamiec_ts/issues/comments{/number}",
    "contents_url": "https://api.github.com/repos/treejamie/jamiec_ts/contents/{+path}",
    "compare_url": "https://api.github.com/repos/treejamie/jamiec_ts/compare/{base}...{head}",
    "merges_url": "https://api.github.com/repos/treejamie/jamiec_ts/merges",
    "archive_url": "https://api.github.com/repos/treejamie/jamiec_ts/{archive_format}{/ref}",
    "downloads_url": "https://api.github.com/repos/treejamie/jamiec_ts/downloads",
    "issues_url": "https://api.github.com/repos/treejamie/jamiec_ts/issues{/number}",
    "pulls_url": "https://api.github.com/repos/treejamie/jamiec_ts/pulls{/number}",
    "milestones_url": "https://api.github.com/repos/treejamie/jamiec_ts/milestones{/number}",
    "notifications_url": "https://api.github.com/repos/treejamie/jamiec_ts/notifications{?since,all,participating}",
    "labels_url": "https://api.github.com/repos/treejamie/jamiec_ts/labels{/name}",
    "releases_url": "https://api.github.com/repos/treejamie/jamiec_ts/releases{/id}",
    "deployments_url": "https://api.github.com/repos/treejamie/jamiec_ts/deployments",
    "created_at": "2026-02-06T08:22:38Z",
    "updated_at": "2026-02-07T15:52:30Z",
    "pushed_at": "2026-02-07T15:52:27Z",
    "git_url": "git://github.com/treejamie/jamiec_ts.git",
    "ssh_url": "git@github.com:treejamie/jamiec_ts.git",
    "clone_url": "https://github.com/treejamie/jamiec_ts.git",
    "svn_url": "https://github.com/treejamie/jamiec_ts",
    "homepage": null,
    "size": 36,
    "stargazers_count": 0,
    "watchers_count": 0,
    "language": "TypeScript",
    "has_issues": true,
    "has_projects": true,
    "has_downloads": true,
    "has_wiki": true,
    "has_pages": false,
    "has_discussions": false,
    "forks_count": 0,
    "mirror_url": null,
    "archived": false,
    "disabled": false,
    "open_issues_count": 0,
    "license": null,
    "allow_forking": true,
    "is_template": false,
    "web_commit_signoff_required": false,
    "topics": [

    ],
    "visibility": "public",
    "forks": 0,
    "open_issues": 0,
    "watchers": 0,
    "default_branch": "main"
  },
  "sender": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "user_view_type": "public",
    "site_admin": false
  }
}
```